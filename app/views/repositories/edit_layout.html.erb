<div class="container mt-4">
  <div class="row justify-content-center">
    <div class="col-md-8">
      <div class="card shadow">
        <div class="card-header bg-primary text-white">
          <h4 class="mb-0">
            <i class="bi bi-diagram-3 me-2"></i>SVN ë ˆì´ì•„ì›ƒ êµ¬ì„±
          </h4>
        </div>
        
        <div class="card-body" data-controller="layout-config">
          <%= form_with model: @repository, url: update_layout_repository_path(@repository), local: true do |f| %>
            
            <!-- í˜„ì¬ ê°ì§€ëœ êµ¬ì¡° í‘œì‹œ -->
            <% if @repository.svn_structure.present? %>
              <% svn_struct = @repository.svn_structure %>
              <% layout_type = svn_struct['layout'] %>
              
              <div class="alert alert-<%= layout_type == 'partial_standard' ? 'warning' : 'info' %> mb-4">
                <h6 class="alert-heading">
                  <i class="bi bi-info-circle me-2"></i>ê°ì§€ëœ êµ¬ì¡°
                </h6>
                <div class="small">
                  <% if layout_type == 'non_standard' %>
                    <p class="mb-2">ë¹„í‘œì¤€ ë ˆì´ì•„ì›ƒì´ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. ì •í™•í•œ ë§ˆì´ê·¸ë ˆì´ì…˜ì„ ìœ„í•´ ê²½ë¡œë¥¼ ì§ì ‘ ì§€ì •í•´ì£¼ì„¸ìš”.</p>
                  <% elsif layout_type == 'partial_standard' %>
                    <p class="mb-2 text-danger fw-bold">âš ï¸ ë¶€ë¶„ í‘œì¤€ ë ˆì´ì•„ì›ƒ: ì¼ë¶€ í‘œì¤€ ë””ë ‰í† ë¦¬ê°€ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤.</p>
                    
                    <!-- ê°ì§€ëœ êµ¬ì¡° ìƒì„¸ í‘œì‹œ -->
                    <div class="mb-3">
                      <strong>í‘œì¤€ ë””ë ‰í† ë¦¬ ìƒíƒœ:</strong>
                      <ul class="mb-2">
                        <li class="<%= svn_struct['detected_trunk'] ? 'text-success' : 'text-danger' %>">
                          trunk: <%= svn_struct['detected_trunk'] ? 'âœ“ ì¡´ì¬' : 'âœ— ì—†ìŒ' %>
                        </li>
                        <li class="<%= svn_struct['detected_branches'] ? 'text-success' : 'text-danger' %>">
                          branches: <%= svn_struct['detected_branches'] ? 'âœ“ ì¡´ì¬' : 'âœ— ì—†ìŒ' %>
                        </li>
                        <li class="<%= svn_struct['detected_tags'] ? 'text-success' : 'text-danger' %>">
                          tags: <%= svn_struct['detected_tags'] ? 'âœ“ ì¡´ì¬' : 'âœ— ì—†ìŒ' %>
                        </li>
                      </ul>
                    </div>
                    
                    <!-- trunkê°€ ì—†ëŠ” ê²½ìš° ê°€ì´ë“œ -->
                    <% unless svn_struct['detected_trunk'] %>
                      <div class="alert alert-danger p-2 mb-2">
                        <strong>ğŸš¨ trunk ë””ë ‰í† ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤!</strong>
                        <p class="mb-1 mt-2">ë‹¤ìŒ ì¤‘ í•˜ë‚˜ë¥¼ ì„ íƒí•˜ì„¸ìš”:</p>
                        <ol class="mb-0">
                          <li><strong>ì „ì²´ë¥¼ trunkë¡œ ì§€ì •:</strong> Trunk ê²½ë¡œë¥¼ ë¹„ì›Œë‘ë©´ ì €ì¥ì†Œ ì „ì²´ê°€ trunkë¡œ ì·¨ê¸‰ë©ë‹ˆë‹¤</li>
                          <li><strong>íŠ¹ì • ë””ë ‰í† ë¦¬ ì§€ì •:</strong> ì•„ë˜ ëª©ë¡ì—ì„œ ë©”ì¸ ê°œë°œ ë””ë ‰í† ë¦¬ë¥¼ ì„ íƒí•˜ì„¸ìš”</li>
                        </ol>
                      </div>
                    <% end %>
                  <% end %>
                  
                  <% # ë””ë ‰í† ë¦¬ êµ¬ì¡° í‘œì‹œ %>
                  <% tree_data = svn_struct['tree_structure'] %>
                  <% if tree_data.present? && tree_data.is_a?(Hash) %>
                    <div class="bg-light p-2 rounded">
                      <strong>ğŸ“ ë””ë ‰í† ë¦¬ êµ¬ì¡° (2ë‹¨ê³„):</strong>
                      <div class="mt-2 font-monospace small" style="max-height: 300px; overflow-y: auto; white-space: pre;">
<% tree_data.each_with_index do |(dir_name, sub_items), index| %>
<%= index == tree_data.size - 1 ? 'â””â”€â”€ ' : 'â”œâ”€â”€ ' %>ğŸ“ <%= dir_name %>/
<% if sub_items.present? %>
<% sub_items.first(10).each_with_index do |sub_item, sub_index| %>
<%= index == tree_data.size - 1 ? '    ' : 'â”‚   ' %><%= sub_index == sub_items.size - 1 || sub_index == 9 ? 'â””â”€â”€ ' : 'â”œâ”€â”€ ' %><%= sub_item.end_with?('/') ? 'ğŸ“' : 'ğŸ“„' %> <%= sub_item %>
<% end %>
<% if sub_items.size > 10 %>
<%= index == tree_data.size - 1 ? '    ' : 'â”‚   ' %>â””â”€â”€ ... (<%= sub_items.size - 10 %>ê°œ ë”)
<% end %>
<% end %>
<% end %>
                      </div>
                    </div>
                  <% elsif svn_struct['root_entries'].present? %>
                    <div class="bg-light p-2 rounded">
                      <strong>ğŸ“ ë””ë ‰í† ë¦¬ êµ¬ì¡°:</strong>
                      <div class="mt-2 font-monospace small" style="max-height: 300px; overflow-y: auto; white-space: pre;">
<% svn_struct['root_entries'].each_with_index do |entry, index| %>
<%= index == svn_struct['root_entries'].size - 1 ? 'â””â”€â”€ ' : 'â”œâ”€â”€ ' %><%= entry.end_with?('/') ? 'ğŸ“' : 'ğŸ“„' %> <%= entry.chomp('/') %>
<% end %>
                      </div>
                    </div>
                    
                    <% # ì¶”ì²œ ëŒ€ì²´ ê²½ë¡œ í‘œì‹œ
                       if svn_struct['alternative_trunk'] || svn_struct['alternative_branches'] || svn_struct['alternative_tags'] %>
                      <div class="mt-2 p-2 bg-info bg-opacity-10 rounded">
                        <strong>ğŸ’¡ ì¶”ì²œ ë§¤í•‘:</strong>
                        <ul class="mb-0 mt-1">
                          <% if svn_struct['alternative_trunk'] && !svn_struct['detected_trunk'] %>
                            <li>Trunk: <code><%= svn_struct['alternative_trunk'] %></code></li>
                          <% end %>
                          <% if svn_struct['alternative_branches'] && !svn_struct['detected_branches'] %>
                            <li>Branches: <code><%= svn_struct['alternative_branches'] %></code></li>
                          <% end %>
                          <% if svn_struct['alternative_tags'] && !svn_struct['detected_tags'] %>
                            <li>Tags: <code><%= svn_struct['alternative_tags'] %></code></li>
                          <% end %>
                        </ul>
                      </div>
                    <% end %>
                  <% end %>
                </div>
              </div>
            <% end %>
            
            <!-- ë ˆì´ì•„ì›ƒ íƒ€ì… ì„ íƒ -->
            <div class="mb-4">
              <%= f.label :layout_type, "ë ˆì´ì•„ì›ƒ íƒ€ì…", class: "form-label fw-bold" %>
              <%= f.select :layout_type, 
                  options_for_select([
                    ['í‘œì¤€ ë ˆì´ì•„ì›ƒ (trunk/branches/tags)', 'standard'],
                    ['ì»¤ìŠ¤í…€ ë ˆì´ì•„ì›ƒ (ì§ì ‘ ì§€ì •)', 'custom'],
                    ['í‰ë©´ êµ¬ì¡° (ë¸Œëœì¹˜ ì—†ìŒ)', 'flat']
                  ], @repository.layout_type || 'custom'),
                  {},
                  class: "form-select",
                  data: { action: "change->layout-config#toggleCustomPaths" } %>
              <div class="form-text">
                <ul class="mb-0 mt-2">
                  <li><strong>í‘œì¤€:</strong> SVN ê¶Œì¥ êµ¬ì¡° (trunk, branches, tags)</li>
                  <li><strong>ì»¤ìŠ¤í…€:</strong> ì¡°ì§ë³„ ì»¤ìŠ¤í…€ êµ¬ì¡° (main, develop ë“±)</li>
                  <li><strong>í‰ë©´:</strong> ë¸Œëœì¹˜ ì—†ì´ ë‹¨ì¼ ë””ë ‰í† ë¦¬</li>
                </ul>
              </div>
            </div>
            
            <!-- ì»¤ìŠ¤í…€ ê²½ë¡œ ì…ë ¥ -->
            <div id="custom-paths" data-layout-config-target="customPaths" 
                 class="<%= 'd-none' if @repository.layout_type == 'standard' %>">
              
              <div class="alert alert-warning mb-3">
                <i class="bi bi-exclamation-triangle me-2"></i>
                <strong>ì£¼ì˜:</strong> ì •í™•í•œ ê²½ë¡œë¥¼ ì…ë ¥í•˜ì„¸ìš”. ì˜ëª»ëœ ê²½ë¡œëŠ” íˆìŠ¤í† ë¦¬ ì†ì‹¤ì„ ì•¼ê¸°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
              </div>
              
              <!-- Trunk ê²½ë¡œ -->
              <div class="mb-3">
                <%= f.label :custom_trunk_path, "Trunk ê²½ë¡œ (ë©”ì¸ ê°œë°œ ë¼ì¸)", class: "form-label" %>
                <%= f.text_field :custom_trunk_path, 
                    class: "form-control",
                    placeholder: "ì˜ˆ: trunk, main, src, development/stable",
                    value: @repository.custom_trunk_path || @repository.svn_structure&.dig('alternative_trunk') || @repository.svn_structure&.dig('detected_trunk'),
                    data: { "layout-config-target": "trunkPath" } %>
                <div class="form-text">
                  ë©”ì¸ ê°œë°œì´ ì´ë£¨ì–´ì§€ëŠ” ë””ë ‰í† ë¦¬ ê²½ë¡œ. <strong class="text-danger">ë¹„ì›Œë‘ë©´ ì „ì²´ë¥¼ trunkë¡œ ê°„ì£¼í•©ë‹ˆë‹¤.</strong>
                </div>
              </div>
              
              <!-- Branches ê²½ë¡œ -->
              <div class="mb-3">
                <%= f.label :custom_branches_path, "Branches ê²½ë¡œ (ì„ íƒì‚¬í•­)", class: "form-label" %>
                <%= f.text_field :custom_branches_path, 
                    class: "form-control",
                    placeholder: "ì˜ˆ: branches, features, development/features",
                    value: @repository.custom_branches_path || @repository.svn_structure&.dig('alternative_branches') || @repository.svn_structure&.dig('detected_branches'),
                    data: { "layout-config-target": "branchesPath" } %>
                <div class="form-text">
                  ë¸Œëœì¹˜ê°€ ìœ„ì¹˜í•œ ë””ë ‰í† ë¦¬. ë¸Œëœì¹˜ê°€ ì—†ìœ¼ë©´ ë¹„ì›Œë‘ì„¸ìš”.
                </div>
              </div>
              
              <!-- Tags ê²½ë¡œ -->
              <div class="mb-3">
                <%= f.label :custom_tags_path, "Tags ê²½ë¡œ (ì„ íƒì‚¬í•­)", class: "form-label" %>
                <%= f.text_field :custom_tags_path, 
                    class: "form-control",
                    placeholder: "ì˜ˆ: tags, releases, versions",
                    value: @repository.custom_tags_path || @repository.svn_structure&.dig('alternative_tags') || @repository.svn_structure&.dig('detected_tags'),
                    data: { "layout-config-target": "tagsPath" } %>
                <div class="form-text">
                  íƒœê·¸(ë¦´ë¦¬ì¦ˆ)ê°€ ìœ„ì¹˜í•œ ë””ë ‰í† ë¦¬. íƒœê·¸ê°€ ì—†ìœ¼ë©´ ë¹„ì›Œë‘ì„¸ìš”.
                </div>
              </div>
              
              <!-- ê²½ë¡œ ê²€ì¦ ë²„íŠ¼ -->
              <div class="mb-3">
                <button type="button" 
                        class="btn btn-outline-primary"
                        data-action="click->layout-config#validatePaths"
                        data-url="<%= validate_layout_repository_path(@repository) %>">
                  <i class="bi bi-check-circle me-2"></i>ê²½ë¡œ ê²€ì¦
                </button>
                <div id="validation-result" class="mt-2"></div>
              </div>
            </div>
            
            <!-- ì œì¶œ ë²„íŠ¼ -->
            <div class="d-flex justify-content-between">
              <%= link_to repository_path(@repository), class: "btn btn-secondary" do %>
                <i class="bi bi-arrow-left me-2"></i>ì·¨ì†Œ
              <% end %>
              <%= f.submit "ì €ì¥", class: "btn btn-primary" %>
            </div>
          <% end %>
        </div>
      </div>
      
      <!-- ë„ì›€ë§ -->
      <div class="card mt-3">
        <div class="card-body">
          <h6 class="card-title">
            <i class="bi bi-question-circle me-2"></i>ê²½ë¡œ ì…ë ¥ ì˜ˆì‹œ
          </h6>
          <div class="small">
            <p><strong>í‘œì¤€ êµ¬ì¡°:</strong></p>
            <pre class="bg-light p-2 rounded">repository/
â”œâ”€â”€ trunk/       â†’ ë©”ì¸ ê°œë°œ
â”œâ”€â”€ branches/    â†’ ê¸°ëŠ¥ ë¸Œëœì¹˜
â””â”€â”€ tags/        â†’ ë¦´ë¦¬ì¦ˆ íƒœê·¸</pre>
            
            <p><strong>ì»¤ìŠ¤í…€ êµ¬ì¡° ì˜ˆì‹œ:</strong></p>
            <pre class="bg-light p-2 rounded">repository/
â”œâ”€â”€ main/        â†’ trunk ê²½ë¡œ: "main"
â”œâ”€â”€ features/    â†’ branches ê²½ë¡œ: "features"
â””â”€â”€ releases/    â†’ tags ê²½ë¡œ: "releases"</pre>
            
            <p><strong>ê¹Šì€ êµ¬ì¡° ì˜ˆì‹œ:</strong></p>
            <pre class="bg-light p-2 rounded">repository/
â””â”€â”€ code/
    â”œâ”€â”€ stable/  â†’ trunk ê²½ë¡œ: "code/stable"
    â””â”€â”€ dev/     â†’ branches ê²½ë¡œ: "code/dev"</pre>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  .tree-line {
    white-space: pre;
    font-family: 'Courier New', monospace;
    line-height: 1.4;
  }
  .tree-dir-link {
    color: #0066cc;
    cursor: pointer;
  }
  .tree-dir-link:hover {
    text-decoration: underline !important;
    color: #0052a3;
  }
  .tree-dir-link.selected {
    background-color: #fff3cd;
    padding: 2px 4px;
    border-radius: 3px;
  }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const layoutTypeSelect = document.getElementById('repository_layout_type');
  const customPaths = document.getElementById('custom-paths');
  
  if (layoutTypeSelect && customPaths) {
    layoutTypeSelect.addEventListener('change', function() {
      if (this.value === 'standard') {
        customPaths.classList.add('d-none');
      } else {
        customPaths.classList.remove('d-none');
      }
    });
  }
});
</script>