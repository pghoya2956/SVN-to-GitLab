<div id="<%= dom_id repository %>">
    <!-- ì§„í–‰ ë‹¨ê³„ í‘œì‹œê¸° -->
    <%= render 'progress_steps', repository: repository %>
    
    <!-- ë©”ì¸ ì»¨í…ì¸  ì¹´ë“œ -->
    <div class="card shadow-sm">
      <div class="card-body">
        <div class="row">
          <!-- SVN ì •ë³´ ì„¹ì…˜ -->
          <div class="col-md-4 mb-3 mb-md-0">
            <div class="section-header d-flex align-items-center mb-3">
              <i class="bi bi-hdd-network fs-5 text-primary me-2"></i>
              <h6 class="mb-0">SVN Repository</h6>
            </div>
            <div class="info-compact">
              <div class="mb-2">
                <small class="text-muted d-block">URL</small>
                <code class="text-break small"><%= repository.svn_url %></code>
              </div>
              <div class="mb-2">
                <small class="text-muted d-block">ì¸ì¦</small>
                <span class="badge bg-light text-dark">
                  <i class="bi bi-shield-check me-1"></i>
                  <% if repository.auth_type == 'none' %>
                    ì—†ìŒ (ê³µê°œ)
                  <% else %>
                    <%= repository.auth_type.capitalize %>
                    <% if repository.username.present? %>
                      (<%= repository.username %>)
                    <% end %>
                  <% end %>
                </span>
              </div>
            </div>
          </div>
          
          <!-- SVN êµ¬ì¡° ì„¹ì…˜ -->
          <div class="col-md-4 mb-3 mb-md-0 border-start">
            <div class="section-header d-flex align-items-center justify-content-between mb-3">
              <div class="d-flex align-items-center">
                <i class="bi bi-diagram-3 fs-5 text-primary me-2"></i>
                <h6 class="mb-0">SVN êµ¬ì¡°</h6>
                <% if repository.svn_structure.present? %>
                  <i class="bi bi-check-circle-fill text-success ms-2" title="ì™„ë£Œë¨"></i>
                <% end %>
              </div>
            </div>
            
            <div data-controller="svn-detector" class="info-compact">
              <div data-svn-detector-target="structureInfo">
                <% # ì§„í–‰ ì¤‘ì¸ êµ¬ì¡° ê°ì§€ ì‘ì—… í™•ì¸
                   active_detection = repository.jobs.where(job_type: 'structure_detection', status: ['pending', 'running']).first %>
                <% if active_detection %>
                  <div class="alert alert-info p-2 mb-2" data-svn-detector-target="progressCard">
                    <div class="d-flex align-items-center">
                      <div class="spinner-border spinner-border-sm me-2" role="status">
                        <span class="visually-hidden">Loading...</span>
                      </div>
                      <div class="flex-grow-1">
                        <strong>êµ¬ì¡° ê°ì§€ ì§„í–‰ ì¤‘...</strong><br>
                        <small>ë‹¤ë¥¸ í˜ì´ì§€ë¡œ ì´ë™í•´ë„ ê³„ì† ì§„í–‰ë©ë‹ˆë‹¤.</small>
                      </div>
                    </div>
                    <div class="mt-2 p-2 bg-dark text-light rounded" style="font-family: monospace; font-size: 0.75rem; max-height: 150px; overflow-y: auto;">
                      <div data-svn-detector-target="progressLog">
                        <div class="text-warning">ğŸ”„ êµ¬ì¡° ê°ì§€ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤...</div>
                      </div>
                    </div>
                    <div class="mt-2">
                      <%= link_to job_path(active_detection), class: "btn btn-sm btn-primary", target: "_blank" do %>
                        <i class="bi bi-eye me-1"></i>ì „ì²´ ë¡œê·¸ ë³´ê¸°
                      <% end %>
                    </div>
                  </div>
                <% else %>
                  <% if repository.svn_structure.present? %>
                  <div class="structure-summary">
                    <% # ë ˆì´ì•„ì›ƒ íƒ€ì… ê²°ì • - ì»¤ìŠ¤í…€ ì„¤ì •ì´ ìˆìœ¼ë©´ custom, ì—†ìœ¼ë©´ ê°ì§€ëœ íƒ€ì… %>
                    <% display_layout = repository.layout_type == 'custom' ? 'custom' : repository.svn_structure['layout'] %>
                    <% badge_class = display_layout == 'custom' ? 'primary' : 'success' %>
                    <% layout_label = display_layout == 'custom' ? 'ì»¤ìŠ¤í…€ ë ˆì´ì•„ì›ƒ' : 'í‘œì¤€ ë ˆì´ì•„ì›ƒ' %>
                    
                    <span class="badge bg-<%= badge_class %> mb-2">
                      <i class="bi bi-<%= display_layout == 'custom' ? 'gear' : 'check-circle' %> me-1"></i>
                      <%= layout_label %>
                    </span>
                    
                    <div class="small">
                      <% # ì»¤ìŠ¤í…€ ê²½ë¡œ ì„¤ì • í‘œì‹œ %>
                      <% if repository.layout_type == 'custom' %>
                        <div class="mb-2">
                          <strong>ì»¤ìŠ¤í…€ ê²½ë¡œ ì„¤ì •:</strong><br>
                          <% if repository.custom_trunk_path.present? %>
                            <span class="text-primary">Trunk:</span> <code><%= repository.custom_trunk_path %></code><br>
                          <% end %>
                          <% if repository.custom_branches_path.present? %>
                            <span class="text-success">Branches:</span> <code><%= repository.custom_branches_path %></code><br>
                          <% end %>
                          <% if repository.custom_tags_path.present? %>
                            <span class="text-info">Tags:</span> <code><%= repository.custom_tags_path %></code><br>
                          <% end %>
                        </div>
                      <% else %>
                        <% # ê°ì§€ëœ í‘œì¤€ êµ¬ì¡° í‘œì‹œ %>
                        <div class="mb-2">
                          <strong>ê°ì§€ëœ í‘œì¤€ êµ¬ì¡°:</strong><br>
                          <span class="text-success">trunk âœ“</span><br>
                          <span class="text-success">branches âœ“</span><br>
                          <span class="text-success">tags âœ“</span>
                        </div>
                      <% end %>
                      
                      <% if repository.total_revisions.present? %>
                        <div class="mt-2">
                          <i class="bi bi-info-circle text-muted me-1"></i>
                          <span class="text-muted">ì´ ë¦¬ë¹„ì „: <strong><%= number_with_delimiter(repository.total_revisions) %></strong></span>
                        </div>
                      <% end %>
                    </div>
                    
                    <div class="d-flex gap-2 mt-2">
                      <%= link_to edit_layout_repository_path(repository), class: "btn btn-sm btn-outline-primary" do %>
                        <i class="bi bi-pencil me-1"></i>ê²½ë¡œ ìˆ˜ì •
                      <% end %>
                      
                      <button type="button"
                          class="btn btn-sm btn-outline-secondary"
                          data-svn-detector-target="button"
                          data-action="click->svn-detector#detect"
                          data-url="<%= detect_structure_repository_path(repository) %>"
                          data-repository-id="<%= repository.id %>">
                        <span class="spinner-border spinner-border-sm d-none me-1" 
                              role="status" 
                              data-svn-detector-target="spinner"></span>
                        <i class="bi bi-arrow-clockwise me-1"></i>
                        <span data-svn-detector-target="buttonText">ì¬ê°ì§€</span>
                      </button>
                      
                      <% # ìµœê·¼ êµ¬ì¡° ê°ì§€ Job ì°¾ê¸°
                         last_detection = repository.jobs.where(job_type: 'structure_detection').order(created_at: :desc).first %>
                      <% if last_detection %>
                        <%= link_to job_path(last_detection), class: "btn btn-sm btn-outline-info", 
                            title: "ë§ˆì§€ë§‰ ê°ì§€: #{last_detection.created_at.strftime('%Y-%m-%d %H:%M')}" do %>
                          <i class="bi bi-file-text me-1"></i>ë¡œê·¸
                        <% end %>
                      <% end %>
                    </div>
                  </div>
                <% else %>
                  <button type="button"
                      class="btn btn-primary btn-sm w-100"
                      data-svn-detector-target="button"
                      data-action="click->svn-detector#detect"
                      data-url="<%= detect_structure_repository_path(repository) %>"
                      data-repository-id="<%= repository.id %>">
                    <span class="spinner-border spinner-border-sm d-none me-1" 
                          role="status" 
                          data-svn-detector-target="spinner"></span>
                    <i class="bi bi-search me-1"></i>
                    <span data-svn-detector-target="buttonText">êµ¬ì¡° ê°ì§€í•˜ê¸°</span>
                  </button>
                  <small class="text-muted d-block mt-1">SVN ë ˆì´ì•„ì›ƒì„ ìë™ìœ¼ë¡œ ê°ì§€í•©ë‹ˆë‹¤</small>
                  <% end %>
                <% end %>
              </div>
              
              <div data-svn-detector-target="result" class="mt-2">
                <!-- ê°ì§€ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
              </div>
            </div>
          </div>
          
          <!-- ë§ˆì´ê·¸ë ˆì´ì…˜ ì „ëµ ì„¹ì…˜ -->
          <div class="col-md-4 border-start">
            <div class="section-header d-flex align-items-center justify-content-between mb-3">
              <div class="d-flex align-items-center">
                <i class="bi bi-sliders fs-5 text-primary me-2"></i>
                <h6 class="mb-0">ë§ˆì´ê·¸ë ˆì´ì…˜ ì „ëµ</h6>
                <% if repository.migration_type.present? %>
                  <i class="bi bi-check-circle-fill text-success ms-2" title="ì™„ë£Œë¨"></i>
                <% end %>
              </div>
            </div>
            
            <div class="info-compact">
              <% if repository.migration_type.present? %>
                <div class="strategy-summary">
                  <span class="badge bg-<%= repository.migration_method == 'git-svn' ? 'success' : 'secondary' %> mb-2">
                    <%= repository.migration_method == 'git-svn' ? 'ì „ì²´ ì´ë ¥ ë³´ì¡´' : 'ìµœì‹  íŒŒì¼ë§Œ' %>
                  </span>
                  <div class="small text-muted">
                    íƒ€ì…: <%= repository.migration_type.humanize %>
                  </div>
                  <%= link_to edit_strategy_repository_path(repository), class: "btn btn-sm btn-outline-primary mt-2" do %>
                    <i class="bi bi-pencil me-1"></i>ìˆ˜ì •
                  <% end %>
                </div>
              <% else %>
                <% if repository.svn_structure.present? %>
                  <%= link_to edit_strategy_repository_path(repository), class: "btn btn-primary btn-sm w-100" do %>
                    <i class="bi bi-sliders me-1"></i>ì „ëµ ì„¤ì •í•˜ê¸°
                  <% end %>
                  <small class="text-muted d-block mt-1">ë§ˆì´ê·¸ë ˆì´ì…˜ ì˜µì…˜ì„ ì„¤ì •í•©ë‹ˆë‹¤</small>
                <% else %>
                  <div class="text-muted small">
                    <i class="bi bi-info-circle me-1"></i>ë¨¼ì € SVN êµ¬ì¡°ë¥¼ ê°ì§€í•´ì£¼ì„¸ìš”
                  </div>
                <% end %>
              <% end %>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- GitLab í”„ë¡œì íŠ¸ ì„¹ì…˜ -->
    <div class="card shadow-sm mt-3">
      <div class="card-body">
        <div class="section-header d-flex align-items-center justify-content-between mb-3">
          <div class="d-flex align-items-center">
            <i class="bi bi-gitlab fs-5 text-primary me-2"></i>
            <h6 class="mb-0">GitLab ëŒ€ìƒ í”„ë¡œì íŠ¸</h6>
            <% if repository.gitlab_project_id.present? %>
              <i class="bi bi-check-circle-fill text-success ms-2" title="ì™„ë£Œë¨"></i>
            <% end %>
          </div>
        </div>
        
        <% if repository.gitlab_project_id.present? %>
          <div class="d-flex align-items-center justify-content-between">
            <div>
              <div class="d-flex align-items-center mb-2">
                <i class="bi bi-folder2-open text-primary me-2"></i>
                <span class="fw-semibold"><%= repository.gitlab_project_path %></span>
              </div>
              <%= link_to repository.gitlab_project_url, target: "_blank", rel: "noopener", class: "text-decoration-none small" do %>
                <i class="bi bi-box-arrow-up-right me-1"></i>GitLabì—ì„œ ë³´ê¸°
              <% end %>
            </div>
            <div>
              <%= link_to gitlab_projects_path(repository_id: repository.id), class: "btn btn-sm btn-outline-primary" do %>
                <i class="bi bi-arrow-left-right me-1"></i>í”„ë¡œì íŠ¸ ë³€ê²½
              <% end %>
            </div>
          </div>
        <% else %>
          <% if repository.migration_type.present? %>
            <div class="text-center py-3">
              <% if gitlab_authenticated? %>
                <%= link_to gitlab_projects_path(repository_id: repository.id), class: "btn btn-primary" do %>
                  <i class="bi bi-folder-plus me-1"></i>GitLab í”„ë¡œì íŠ¸ ì„ íƒ
                <% end %>
                <p class="text-muted small mt-2 mb-0">ë§ˆì´ê·¸ë ˆì´ì…˜í•  ëŒ€ìƒ í”„ë¡œì íŠ¸ë¥¼ ì„ íƒí•˜ì„¸ìš”</p>
              <% else %>
                <%= link_to login_path, class: "btn btn-warning" do %>
                  <i class="bi bi-key me-1"></i>GitLab ë¡œê·¸ì¸ í•„ìš”
                <% end %>
                <p class="text-muted small mt-2 mb-0">ë¨¼ì € GitLab PATë¡œ ë¡œê·¸ì¸í•˜ì„¸ìš”</p>
              <% end %>
            </div>
          <% else %>
            <div class="text-muted small">
              <i class="bi bi-info-circle me-1"></i>ë¨¼ì € ë§ˆì´ê·¸ë ˆì´ì…˜ ì „ëµì„ ì„¤ì •í•´ì£¼ì„¸ìš”
            </div>
          <% end %>
        <% end %>
      </div>
    </div>
    
    <!-- Authors ì„¹ì…˜ -->
    <% if repository.authors_mapping.present? && repository.authors_mapping.is_a?(Array) && repository.authors_mapping.any? %>
      <div class="card shadow-sm mt-3">
        <div class="card-body">
          <div class="section-header d-flex align-items-center justify-content-between mb-3">
            <div class="d-flex align-items-center">
              <i class="bi bi-people fs-5 text-primary me-2"></i>
              <h6 class="mb-0">Authors (<%= repository.authors_mapping.size %>ëª…)</h6>
            </div>
            <%= link_to edit_authors_repository_path(repository), class: "btn btn-sm btn-outline-primary" do %>
              <i class="bi bi-pencil me-1"></i>í¸ì§‘
            <% end %>
          </div>
          <div class="authors-preview">
            <% repository.authors_mapping.first(3).each do |author| %>
              <div class="author-item small">
                <i class="bi bi-person-circle text-muted me-2"></i>
                <span class="text-muted"><%= author['svn_name'] %></span>
                <i class="bi bi-arrow-right mx-2 text-muted"></i>
                <span><%= author['git_name'] %> &lt;<%= author['git_email'] %>&gt;</span>
              </div>
            <% end %>
            <% if repository.authors_mapping.size > 3 %>
              <div class="text-muted small mt-1">
                ... ê·¸ ì™¸ <%= repository.authors_mapping.size - 3 %>ëª…
              </div>
            <% end %>
          </div>
        </div>
      </div>
    <% end %>
    
    <!-- ì¦ë¶„ ë™ê¸°í™” ì„¹ì…˜ (Full Modeë¡œ ë§ˆì´ê·¸ë ˆì´ì…˜ëœ ê²½ìš°ì—ë§Œ í‘œì‹œ) -->
    <% if repository.migration_method == 'git-svn' && repository.initial_migration_completed? %>
      <div class="card shadow-sm mt-3">
        <div class="card-body">
          <div class="section-header d-flex align-items-center justify-content-between mb-3">
            <div class="d-flex align-items-center">
              <i class="bi bi-arrow-repeat fs-5 text-primary me-2"></i>
              <h6 class="mb-0">ì¦ë¶„ ë™ê¸°í™”</h6>
            </div>
            <% if repository.gitlab_project_id.present? %>
              <%= link_to sync_repository_path(repository), 
                  method: :post,
                  data: { "turbo-method": :post, "turbo-confirm": "SVNì˜ ìƒˆ ì»¤ë°‹ì„ ë™ê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?" },
                  class: "btn btn-sm btn-warning" do %>
                <i class="bi bi-arrow-repeat me-1"></i>ì§€ê¸ˆ ë™ê¸°í™”
              <% end %>
            <% end %>
          </div>
          <div class="sync-status">
            <div class="row small">
              <div class="col-6">
                <span class="text-muted">ë§ˆì§€ë§‰ ë™ê¸°í™”:</span>
                <span class="ms-2"><%= repository.last_synced_at ? repository.last_synced_at.strftime("%m/%d %H:%M") : "ì´ˆê¸° ë§ˆì´ê·¸ë ˆì´ì…˜ ì´í›„ ì—†ìŒ" %></span>
              </div>
              <div class="col-6">
                <span class="text-muted">ë§ˆì§€ë§‰ ë¦¬ë¹„ì „:</span>
                <span class="ms-2"><%= repository.last_synced_revision || "N/A" %></span>
              </div>
            </div>
            <div class="mt-2 text-muted small">
              <i class="bi bi-info-circle"></i> SVNì˜ ìƒˆë¡œìš´ ì»¤ë°‹ì„ Gitìœ¼ë¡œ ê°€ì ¸ì˜µë‹ˆë‹¤
            </div>
          </div>
        </div>
      </div>
    <% end %>
</div>

<style>
  /* ì„¹ì…˜ ìŠ¤íƒ€ì¼ */
  .section-header {
    border-bottom: 1px solid #e9ecef;
    padding-bottom: 0.75rem;
  }
  
  .info-compact {
    font-size: 0.875rem;
  }
  
  .structure-summary,
  .strategy-summary {
    padding: 0.5rem;
    background: #f8f9fa;
    border-radius: 0.375rem;
  }
  
  .authors-preview {
    max-height: 120px;
    overflow-y: auto;
  }
  
  .author-item {
    padding: 0.25rem 0;
    border-bottom: 1px solid #f0f0f0;
  }
  
  .author-item:last-child {
    border-bottom: none;
  }
  
  /* ì¹´ë“œ í˜¸ë²„ íš¨ê³¼ */
  .card {
    transition: all 0.2s ease;
    border: 1px solid #e9ecef;
  }
  
  .card:hover {
    box-shadow: 0 0.25rem 0.5rem rgba(0,0,0,0.08) !important;
  }
  
  /* ìƒíƒœë³„ ê°•ì¡° íš¨ê³¼ */
  .progress-step.active ~ .card:first-of-type {
    border-color: #0d6efd;
  }
  
  /* êµ¬ì¡° ê°ì§€ ì„¹ì…˜ í•˜ì´ë¼ì´íŠ¸ */
  .highlight-section {
    animation: highlightPulse 2s ease-in-out;
  }
  
  @keyframes highlightPulse {
    0% { background-color: transparent; }
    50% { background-color: rgba(13, 110, 253, 0.1); }
    100% { background-color: transparent; }
  }
</style>
