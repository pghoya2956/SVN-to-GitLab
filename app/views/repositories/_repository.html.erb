<div id="<%= dom_id repository %>">
    <!-- ÏßÑÌñâ Îã®Í≥Ñ ÌëúÏãúÍ∏∞ -->
    <%= render 'progress_steps', repository: repository %>
    
    <!-- Î©îÏù∏ Ïª®ÌÖêÏ∏† Ïπ¥Îìú -->
    <div class="card shadow-sm">
      <div class="card-body">
        <div class="row">
          <!-- SVN Ï†ïÎ≥¥ ÏÑπÏÖò -->
          <div class="col-md-4 mb-3 mb-md-0">
            <div class="section-header d-flex align-items-center mb-3">
              <i class="bi bi-hdd-network fs-5 text-primary me-2"></i>
              <h6 class="mb-0">SVN Repository</h6>
            </div>
            <div class="info-compact">
              <div class="mb-2">
                <small class="text-muted d-block">URL</small>
                <code class="text-break small"><%= repository.svn_url %></code>
              </div>
              <div class="mb-2">
                <small class="text-muted d-block">Ïù∏Ï¶ù</small>
                <span class="badge bg-light text-dark">
                  <i class="bi bi-shield-check me-1"></i>
                  <% if repository.auth_type == 'none' %>
                    ÏóÜÏùå (Í≥µÍ∞ú)
                  <% else %>
                    <%= repository.auth_type.capitalize %>
                    <% if repository.username.present? %>
                      (<%= repository.username %>)
                    <% end %>
                  <% end %>
                </span>
              </div>
            </div>
          </div>
          
          <!-- SVN Íµ¨Ï°∞ ÏÑπÏÖò -->
          <div class="col-md-4 mb-3 mb-md-0 border-start">
            <div class="section-header d-flex align-items-center justify-content-between mb-3">
              <div class="d-flex align-items-center">
                <i class="bi bi-diagram-3 fs-5 text-primary me-2"></i>
                <h6 class="mb-0">SVN Íµ¨Ï°∞</h6>
                <% if repository.svn_structure.present? %>
                  <i class="bi bi-check-circle-fill text-success ms-2" title="ÏôÑÎ£åÎê®"></i>
                <% end %>
              </div>
            </div>
            
            <div data-controller="svn-detector" class="info-compact">
              <div data-svn-detector-target="structureInfo">
                <% # ÏßÑÌñâ Ï§ëÏù∏ Íµ¨Ï°∞ Í∞êÏßÄ ÏûëÏóÖ ÌôïÏù∏
                   active_detection = repository.jobs.where(job_type: 'structure_detection', status: ['pending', 'running']).first %>
                <% if active_detection %>
                  <div class="alert alert-info p-2 mb-2" data-svn-detector-target="progressCard">
                    <div class="d-flex align-items-center">
                      <div class="spinner-border spinner-border-sm me-2" role="status">
                        <span class="visually-hidden">Loading...</span>
                      </div>
                      <div class="flex-grow-1">
                        <strong>Íµ¨Ï°∞ Í∞êÏßÄ ÏßÑÌñâ Ï§ë...</strong><br>
                        <small>Îã§Î•∏ ÌéòÏù¥ÏßÄÎ°ú Ïù¥ÎèôÌï¥ÎèÑ Í≥ÑÏÜç ÏßÑÌñâÎê©ÎãàÎã§.</small>
                      </div>
                    </div>
                    <div class="mt-2 p-2 bg-dark text-light rounded" style="font-family: monospace; font-size: 0.75rem; max-height: 150px; overflow-y: auto;">
                      <div data-svn-detector-target="progressLog">
                        <div class="text-warning">üîÑ Íµ¨Ï°∞ Í∞êÏßÄÎ•º ÏãúÏûëÌï©ÎãàÎã§...</div>
                      </div>
                    </div>
                    <div class="mt-2">
                      <%= link_to job_path(active_detection), class: "btn btn-sm btn-primary", target: "_blank" do %>
                        <i class="bi bi-eye me-1"></i>Ï†ÑÏ≤¥ Î°úÍ∑∏ Î≥¥Í∏∞
                      <% end %>
                    </div>
                  </div>
                <% else %>
                  <% if repository.svn_structure.present? %>
                  <div class="structure-summary">
                    <% # Î†àÏù¥ÏïÑÏõÉ ÌÉÄÏûÖ Í≤∞Ï†ï - Ïª§Ïä§ÌÖÄ ÏÑ§Ï†ïÏù¥ ÏûàÏúºÎ©¥ custom, ÏóÜÏúºÎ©¥ Í∞êÏßÄÎêú ÌÉÄÏûÖ %>
                    <% display_layout = repository.layout_type == 'custom' ? 'custom' : repository.svn_structure['layout'] %>
                    <% badge_class = display_layout == 'custom' ? 'primary' : 'success' %>
                    <% layout_label = display_layout == 'custom' ? 'Ïª§Ïä§ÌÖÄ Î†àÏù¥ÏïÑÏõÉ' : 'ÌëúÏ§Ä Î†àÏù¥ÏïÑÏõÉ' %>
                    
                    <span class="badge bg-<%= badge_class %> mb-2">
                      <i class="bi bi-<%= display_layout == 'custom' ? 'gear' : 'check-circle' %> me-1"></i>
                      <%= layout_label %>
                    </span>
                    
                    <div class="small">
                      <% # Ïª§Ïä§ÌÖÄ Í≤ΩÎ°ú ÏÑ§Ï†ï ÌëúÏãú %>
                      <% if repository.layout_type == 'custom' %>
                        <div class="mb-2">
                          <strong>Ïª§Ïä§ÌÖÄ Í≤ΩÎ°ú ÏÑ§Ï†ï:</strong><br>
                          <% if repository.custom_trunk_path.present? %>
                            <span class="text-primary">Trunk:</span> <code><%= repository.custom_trunk_path %></code><br>
                          <% end %>
                          <% if repository.custom_branches_path.present? %>
                            <span class="text-success">Branches:</span> <code><%= repository.custom_branches_path %></code><br>
                          <% end %>
                          <% if repository.custom_tags_path.present? %>
                            <span class="text-info">Tags:</span> <code><%= repository.custom_tags_path %></code><br>
                          <% end %>
                        </div>
                      <% else %>
                        <% # Í∞êÏßÄÎêú ÌëúÏ§Ä Íµ¨Ï°∞ ÌëúÏãú %>
                        <div class="mb-2">
                          <strong>Í∞êÏßÄÎêú ÌëúÏ§Ä Íµ¨Ï°∞:</strong><br>
                          <span class="text-success">trunk ‚úì</span><br>
                          <span class="text-success">branches ‚úì</span><br>
                          <span class="text-success">tags ‚úì</span>
                        </div>
                      <% end %>
                      
                      <% if repository.total_revisions.present? %>
                        <div class="mt-2">
                          <i class="bi bi-info-circle text-muted me-1"></i>
                          <span class="text-muted">Ï¥ù Î¶¨ÎπÑÏ†Ñ: <strong><%= number_with_delimiter(repository.total_revisions) %></strong></span>
                        </div>
                      <% end %>
                    </div>
                    
                    <div class="d-flex gap-2 mt-2">
                      <%= link_to edit_layout_repository_path(repository), class: "btn btn-sm btn-outline-primary" do %>
                        <i class="bi bi-pencil me-1"></i>Í≤ΩÎ°ú ÏàòÏ†ï
                      <% end %>
                      
                      <button type="button"
                          class="btn btn-sm btn-outline-secondary"
                          data-svn-detector-target="button"
                          data-action="click->svn-detector#detect"
                          data-url="<%= detect_structure_repository_path(repository) %>"
                          data-repository-id="<%= repository.id %>">
                        <span class="spinner-border spinner-border-sm d-none me-1" 
                              role="status" 
                              data-svn-detector-target="spinner"></span>
                        <i class="bi bi-arrow-clockwise me-1"></i>
                        <span data-svn-detector-target="buttonText">Ïû¨Í∞êÏßÄ</span>
                      </button>
                      
                      <% # ÏµúÍ∑º Íµ¨Ï°∞ Í∞êÏßÄ Job Ï∞æÍ∏∞
                         last_detection = repository.jobs.where(job_type: 'structure_detection').order(created_at: :desc).first %>
                      <% if last_detection %>
                        <%= link_to job_path(last_detection), class: "btn btn-sm btn-outline-info", 
                            title: "ÎßàÏßÄÎßâ Í∞êÏßÄ: #{last_detection.created_at.strftime('%Y-%m-%d %H:%M')}" do %>
                          <i class="bi bi-file-text me-1"></i>Î°úÍ∑∏
                        <% end %>
                      <% end %>
                    </div>
                  </div>
                <% else %>
                  <button type="button"
                      class="btn btn-primary btn-sm w-100"
                      data-svn-detector-target="button"
                      data-action="click->svn-detector#detect"
                      data-url="<%= detect_structure_repository_path(repository) %>"
                      data-repository-id="<%= repository.id %>">
                    <span class="spinner-border spinner-border-sm d-none me-1" 
                          role="status" 
                          data-svn-detector-target="spinner"></span>
                    <i class="bi bi-search me-1"></i>
                    <span data-svn-detector-target="buttonText">Íµ¨Ï°∞ Í∞êÏßÄÌïòÍ∏∞</span>
                  </button>
                  <small class="text-muted d-block mt-1">SVN Î†àÏù¥ÏïÑÏõÉÏùÑ ÏûêÎèôÏúºÎ°ú Í∞êÏßÄÌï©ÎãàÎã§</small>
                  <% end %>
                <% end %>
              </div>
              
              <div data-svn-detector-target="result" class="mt-2">
                <!-- Í∞êÏßÄ Í≤∞Í≥ºÍ∞Ä Ïó¨Í∏∞Ïóê ÌëúÏãúÎê©ÎãàÎã§ -->
              </div>
            </div>
          </div>
          
          <!-- ÎßàÏù¥Í∑∏Î†àÏù¥ÏÖò Ï†ÑÎûµ ÏÑπÏÖò -->
          <div class="col-md-4 border-start">
            <div class="section-header d-flex align-items-center justify-content-between mb-3">
              <div class="d-flex align-items-center">
                <i class="bi bi-sliders fs-5 text-primary me-2"></i>
                <h6 class="mb-0">ÎßàÏù¥Í∑∏Î†àÏù¥ÏÖò Ï†ÑÎûµ</h6>
                <% if repository.migration_type.present? %>
                  <i class="bi bi-check-circle-fill text-success ms-2" title="ÏôÑÎ£åÎê®"></i>
                <% end %>
              </div>
            </div>
            
            <div class="info-compact">
              <% if repository.migration_type.present? %>
                <div class="strategy-summary">
                  <span class="badge bg-<%= repository.migration_method == 'git-svn' ? 'success' : 'secondary' %> mb-2">
                    <%= repository.migration_method == 'git-svn' ? 'Ï†ÑÏ≤¥ Ïù¥Î†• Î≥¥Ï°¥' : 'ÏµúÏã† ÌååÏùºÎßå' %>
                  </span>
                  <div class="small text-muted">
                    ÌÉÄÏûÖ: <%= repository.migration_type.humanize %>
                  </div>
                  <%= link_to edit_strategy_repository_path(repository), class: "btn btn-sm btn-outline-primary mt-2" do %>
                    <i class="bi bi-pencil me-1"></i>ÏàòÏ†ï
                  <% end %>
                </div>
              <% else %>
                <% if repository.svn_structure.present? %>
                  <%= link_to edit_strategy_repository_path(repository), class: "btn btn-primary btn-sm w-100" do %>
                    <i class="bi bi-sliders me-1"></i>Ï†ÑÎûµ ÏÑ§Ï†ïÌïòÍ∏∞
                  <% end %>
                  <small class="text-muted d-block mt-1">ÎßàÏù¥Í∑∏Î†àÏù¥ÏÖò ÏòµÏÖòÏùÑ ÏÑ§Ï†ïÌï©ÎãàÎã§</small>
                <% else %>
                  <div class="text-muted small">
                    <i class="bi bi-info-circle me-1"></i>Î®ºÏ†Ä SVN Íµ¨Ï°∞Î•º Í∞êÏßÄÌï¥Ï£ºÏÑ∏Ïöî
                  </div>
                <% end %>
              <% end %>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- GitLab ÌîÑÎ°úÏ†ùÌä∏ ÏÑπÏÖò -->
    <div class="card shadow-sm mt-3">
      <div class="card-body">
        <div class="section-header d-flex align-items-center justify-content-between mb-3">
          <div class="d-flex align-items-center">
            <i class="bi bi-gitlab fs-5 text-primary me-2"></i>
            <h6 class="mb-0">GitLab ÎåÄÏÉÅ ÌîÑÎ°úÏ†ùÌä∏</h6>
            <% if repository.gitlab_project_id.present? %>
              <i class="bi bi-check-circle-fill text-success ms-2" title="ÏôÑÎ£åÎê®"></i>
            <% end %>
          </div>
        </div>
        
        <% if repository.gitlab_project_id.present? %>
          <div class="d-flex align-items-center justify-content-between">
            <div>
              <div class="d-flex align-items-center mb-2">
                <i class="bi bi-folder2-open text-primary me-2"></i>
                <span class="fw-semibold"><%= repository.gitlab_project_path %></span>
              </div>
              <%= link_to repository.gitlab_project_url, target: "_blank", rel: "noopener", class: "text-decoration-none small" do %>
                <i class="bi bi-box-arrow-up-right me-1"></i>GitLabÏóêÏÑú Î≥¥Í∏∞
              <% end %>
            </div>
            <div>
              <%= link_to gitlab_projects_path(repository_id: repository.id), class: "btn btn-sm btn-outline-primary" do %>
                <i class="bi bi-arrow-left-right me-1"></i>ÌîÑÎ°úÏ†ùÌä∏ Î≥ÄÍ≤Ω
              <% end %>
            </div>
          </div>
        <% else %>
          <% if repository.migration_type.present? %>
            <div class="text-center py-3">
              <% if gitlab_authenticated? %>
                <%= link_to gitlab_projects_path(repository_id: repository.id), class: "btn btn-primary" do %>
                  <i class="bi bi-folder-plus me-1"></i>GitLab ÌîÑÎ°úÏ†ùÌä∏ ÏÑ†ÌÉù
                <% end %>
                <p class="text-muted small mt-2 mb-0">ÎßàÏù¥Í∑∏Î†àÏù¥ÏÖòÌï† ÎåÄÏÉÅ ÌîÑÎ°úÏ†ùÌä∏Î•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî</p>
              <% else %>
                <%= link_to login_path, class: "btn btn-warning" do %>
                  <i class="bi bi-key me-1"></i>GitLab Î°úÍ∑∏Ïù∏ ÌïÑÏöî
                <% end %>
                <p class="text-muted small mt-2 mb-0">Î®ºÏ†Ä GitLab PATÎ°ú Î°úÍ∑∏Ïù∏ÌïòÏÑ∏Ïöî</p>
              <% end %>
            </div>
          <% else %>
            <div class="text-muted small">
              <i class="bi bi-info-circle me-1"></i>Î®ºÏ†Ä ÎßàÏù¥Í∑∏Î†àÏù¥ÏÖò Ï†ÑÎûµÏùÑ ÏÑ§Ï†ïÌï¥Ï£ºÏÑ∏Ïöî
            </div>
          <% end %>
        <% end %>
      </div>
    </div>
    
    <!-- Authors ÏÑπÏÖò -->
    <% if repository.authors_mapping.present? && repository.authors_mapping.is_a?(Array) && repository.authors_mapping.any? %>
      <div class="card shadow-sm mt-3">
        <div class="card-body">
          <div class="section-header d-flex align-items-center justify-content-between mb-3">
            <div class="d-flex align-items-center">
              <i class="bi bi-people fs-5 text-primary me-2"></i>
              <h6 class="mb-0">Authors (<%= repository.authors_mapping.size %>Î™Ö)</h6>
            </div>
            <%= link_to edit_authors_repository_path(repository), class: "btn btn-sm btn-outline-primary" do %>
              <i class="bi bi-pencil me-1"></i>Ìé∏Ïßë
            <% end %>
          </div>
          <div class="authors-preview">
            <% repository.authors_mapping.first(3).each do |author| %>
              <div class="author-item small">
                <i class="bi bi-person-circle text-muted me-2"></i>
                <span class="text-muted"><%= author['svn_name'] %></span>
                <i class="bi bi-arrow-right mx-2 text-muted"></i>
                <span><%= author['git_name'] %> &lt;<%= author['git_email'] %>&gt;</span>
              </div>
            <% end %>
            <% if repository.authors_mapping.size > 3 %>
              <div class="text-muted small mt-1">
                ... Í∑∏ Ïô∏ <%= repository.authors_mapping.size - 3 %>Î™Ö
              </div>
            <% end %>
          </div>
        </div>
      </div>
    <% end %>
    
    <!-- Ï¶ùÎ∂Ñ ÎèôÍ∏∞Ìôî ÏÑπÏÖò (Full ModeÎ°ú ÎßàÏù¥Í∑∏Î†àÏù¥ÏÖòÎêú Í≤ΩÏö∞ÏóêÎßå ÌëúÏãú) -->
    <% if repository.migration_method == 'git-svn' && repository.initial_migration_completed? %>
      <div class="card shadow-sm mt-3">
        <div class="card-body">
          <div class="section-header d-flex align-items-center justify-content-between mb-3">
            <div class="d-flex align-items-center">
              <i class="bi bi-arrow-repeat fs-5 text-primary me-2"></i>
              <h6 class="mb-0">Ï¶ùÎ∂Ñ ÎèôÍ∏∞Ìôî</h6>
            </div>
            <% if repository.gitlab_project_id.present? %>
              <%= link_to sync_repository_path(repository), 
                  method: :post,
                  data: { "turbo-method": :post, "turbo-confirm": "SVNÏùò ÏÉà Ïª§Î∞ãÏùÑ ÎèôÍ∏∞ÌôîÌïòÏãúÍ≤†ÏäµÎãàÍπå?" },
                  class: "btn btn-sm btn-warning" do %>
                <i class="bi bi-arrow-repeat me-1"></i>ÏßÄÍ∏à ÎèôÍ∏∞Ìôî
              <% end %>
            <% end %>
          </div>
          <div class="sync-status">
            <div class="row small">
              <div class="col-6">
                <span class="text-muted">ÎßàÏßÄÎßâ ÎèôÍ∏∞Ìôî:</span>
                <span class="ms-2"><%= repository.last_synced_at ? repository.last_synced_at.strftime("%m/%d %H:%M") : "Ï¥àÍ∏∞ ÎßàÏù¥Í∑∏Î†àÏù¥ÏÖò Ïù¥ÌõÑ ÏóÜÏùå" %></span>
              </div>
              <div class="col-6">
                <span class="text-muted">ÎßàÏßÄÎßâ Î¶¨ÎπÑÏ†Ñ:</span>
                <span class="ms-2"><%= repository.last_synced_revision || "N/A" %></span>
              </div>
            </div>
            <div class="mt-2 text-muted small">
              <i class="bi bi-info-circle"></i> SVNÏùò ÏÉàÎ°úÏö¥ Ïª§Î∞ãÏùÑ GitÏúºÎ°ú Í∞ÄÏ†∏ÏòµÎãàÎã§
            </div>
          </div>
        </div>
      </div>
    <% end %>
</div>

<style>
  /* ÏÑπÏÖò Ïä§ÌÉÄÏùº */
  .section-header {
    border-bottom: 1px solid #e9ecef;
    padding-bottom: 0.75rem;
  }
  
  .info-compact {
    font-size: 0.875rem;
  }
  
  .structure-summary,
  .strategy-summary {
    padding: 0.5rem;
    background: #f8f9fa;
    border-radius: 0.375rem;
  }
  
  .authors-preview {
    max-height: 120px;
    overflow-y: auto;
  }
  
  .author-item {
    padding: 0.25rem 0;
    border-bottom: 1px solid #f0f0f0;
  }
  
  .author-item:last-child {
    border-bottom: none;
  }
  
  /* Ïπ¥Îìú Ìò∏Î≤Ñ Ìö®Í≥º */
  .card {
    transition: all 0.2s ease;
    border: 1px solid #e9ecef;
  }
  
  .card:hover {
    box-shadow: 0 0.25rem 0.5rem rgba(0,0,0,0.08) !important;
  }
  
  /* ÏÉÅÌÉúÎ≥Ñ Í∞ïÏ°∞ Ìö®Í≥º */
  .progress-step.active ~ .card:first-of-type {
    border-color: #0d6efd;
  }
  
  /* Íµ¨Ï°∞ Í∞êÏßÄ ÏÑπÏÖò ÌïòÏù¥ÎùºÏù¥Ìä∏ */
  .highlight-section {
    animation: highlightPulse 2s ease-in-out;
  }
  
  @keyframes highlightPulse {
    0% { background-color: transparent; }
    50% { background-color: rgba(13, 110, 253, 0.1); }
    100% { background-color: transparent; }
  }
</style>
