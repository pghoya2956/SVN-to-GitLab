<div data-controller="repository-subscription" 
     data-repository-subscription-repository-id-value="<%= @repository.id %>">
  
<div class="page-header d-flex justify-content-between align-items-start mb-4">
  <div>
    <h1><%= @repository.name %></h1>
    <p class="text-muted mb-0">
      <i class="bi bi-folder-fill me-1"></i> SVN Repository
      <span class="mx-2">•</span>
      <i class="bi bi-clock me-1"></i> Created <%= @repository.created_at.strftime('%B %d, %Y') %>
    </p>
  </div>
  <div class="header-actions">
    <% 
      # 마이그레이션 시작 가능 조건 체크
      svn_structure = @repository.parsed_svn_structure
      layout_type = svn_structure['layout'] || 'unknown'
      layout_configured = layout_type == 'standard' || 
                         (layout_type != 'standard' && @repository.layout_type == 'custom' && 
                          (@repository.custom_trunk_path.present? || @repository.custom_branches_path.present? || @repository.custom_tags_path.present?))
      
      can_start_migration = @repository.gitlab_project_id.present? && 
                           @repository.migration_type.present? && 
                           @repository.svn_structure.present? &&
                           layout_configured
    %>
    
    <% if can_start_migration %>
      <%= link_to new_repository_job_path(@repository), class: "btn btn-success btn-lg", id: "start-migration-btn" do %>
        <i class="bi bi-rocket-takeoff me-2"></i>마이그레이션 시작
      <% end %>
    <% else %>
      <button class="btn btn-secondary btn-lg" disabled 
              data-bs-toggle="tooltip" 
              data-bs-placement="bottom" 
              title="<%= !layout_configured ? '비표준 레이아웃의 경로 설정이 필요합니다' : '모든 설정을 완료한 후 마이그레이션을 시작할 수 있습니다' %>">
        <i class="bi bi-rocket me-2"></i>마이그레이션 시작
      </button>
    <% end %>
  </div>
</div>

<%= render @repository %>

<div class="mt-5">
  <%
    # 모든 Job 확인 (구조 감지 포함)
    all_jobs = @repository.jobs
    has_any_jobs = all_jobs.any?
  %>
  
  <% if has_any_jobs %>
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h3 class="mb-0">
        <i class="bi bi-clock-history me-2"></i>Migration History
      </h3>
      <%= link_to jobs_path(repository_id: @repository.id), class: "btn btn-sm btn-outline-primary" do %>
        <i class="bi bi-list"></i> View All Jobs
      <% end %>
    </div>
    
    <!-- Job Type 탭 -->
    <ul class="nav nav-tabs mb-3" id="jobTabs" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="migrations-tab" data-bs-toggle="tab" data-bs-target="#migrations" type="button" role="tab">
          <i class="bi bi-arrow-left-right me-1"></i>
          Migrations (<%= @repository.jobs.where(job_type: 'migration').count %>)
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="syncs-tab" data-bs-toggle="tab" data-bs-target="#syncs" type="button" role="tab">
          <i class="bi bi-arrow-repeat me-1"></i>
          Incremental Syncs (<%= @repository.jobs.where(job_type: 'incremental_sync').count %>)
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="detection-tab" data-bs-toggle="tab" data-bs-target="#detection" type="button" role="tab">
          <i class="bi bi-diagram-3 me-1"></i>
          Structure Detection (<%= @repository.jobs.where(job_type: 'structure_detection').count %>)
        </button>
      </li>
    </ul>
    
    <!-- 탭 콘텐츠 -->
    <div class="tab-content" id="jobTabContent">
      <!-- Migration 탭 -->
      <div class="tab-pane fade show active" id="migrations" role="tabpanel">
        <% migration_jobs_list = @repository.jobs.where(job_type: 'migration').recent.limit(5) %>
        <% if migration_jobs_list.any? %>
          <%= render 'job_table', jobs: migration_jobs_list %>
        <% else %>
          <p class="text-muted">No migration jobs yet.</p>
        <% end %>
      </div>
      
      <!-- Incremental Sync 탭 -->
      <div class="tab-pane fade" id="syncs" role="tabpanel">
        <% sync_jobs_list = @repository.jobs.where(job_type: 'incremental_sync').recent.limit(5) %>
        <% if sync_jobs_list.any? %>
          <%= render 'job_table', jobs: sync_jobs_list %>
        <% else %>
          <p class="text-muted">No incremental sync jobs yet.</p>
        <% end %>
      </div>
      
      <!-- Structure Detection 탭 -->
      <div class="tab-pane fade" id="detection" role="tabpanel">
        <% detection_jobs_list = @repository.jobs.where(job_type: 'structure_detection').recent.limit(5) %>
        <% if detection_jobs_list.any? %>
          <%= render 'job_table', jobs: detection_jobs_list %>
        <% else %>
          <p class="text-muted">No structure detection jobs yet.</p>
        <% end %>
      </div>
    </div>
    
    <% if all_jobs.count > 5 %>
      <p class="mt-3">
        <%= link_to "View all #{all_jobs.count} jobs", jobs_path(repository_id: @repository.id), class: "text-primary" %>
      </p>
    <% end %>
  <% else %>
    <div class="empty-state">
      <i class="bi bi-inbox"></i>
      <p>No jobs have been run for this repository yet.</p>
    </div>
  <% end %>
</div>

<div class="mt-5 pt-4 border-top">
  <div class="action-buttons">
    <%= link_to edit_repository_path(@repository), class: "btn-secondary-action" do %>
      <i class="bi bi-pencil"></i> Edit Repository
    <% end %>
    <%= link_to repositories_path, class: "btn btn-outline-secondary" do %>
      <i class="bi bi-arrow-left"></i> Back to Repositories
    <% end %>
    <div class="ms-auto">
      <%= button_to @repository, method: :delete, 
                    data: { confirm: "Are you sure you want to delete this repository? This action cannot be undone." }, 
                    class: "btn-danger-action" do %>
        <i class="bi bi-trash"></i> Delete Repository
      <% end %>
    </div>
  </div>
</div>

</div>
