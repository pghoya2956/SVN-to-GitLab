<div class="page-header d-flex justify-content-between align-items-start mb-4">
  <div>
    <h1><%= @repository.name %></h1>
    <p class="text-muted mb-0">
      <i class="bi bi-folder-fill me-1"></i> SVN Repository
      <span class="mx-2">•</span>
      <i class="bi bi-clock me-1"></i> Created <%= @repository.created_at.strftime('%B %d, %Y') %>
    </p>
  </div>
  <div class="header-actions">
    <% 
      # 마이그레이션 시작 가능 조건 체크
      svn_structure = @repository.parsed_svn_structure
      layout_type = svn_structure['layout'] || 'unknown'
      layout_configured = layout_type == 'standard' || 
                         (layout_type != 'standard' && @repository.layout_type == 'custom' && 
                          (@repository.custom_trunk_path.present? || @repository.custom_branches_path.present? || @repository.custom_tags_path.present?))
      
      can_start_migration = @repository.gitlab_project_id.present? && 
                           @repository.migration_type.present? && 
                           @repository.svn_structure.present? &&
                           layout_configured
    %>
    
    <% if can_start_migration %>
      <%= link_to new_repository_job_path(@repository), class: "btn btn-success btn-lg", id: "start-migration-btn" do %>
        <i class="bi bi-rocket-takeoff me-2"></i>마이그레이션 시작
      <% end %>
    <% else %>
      <button class="btn btn-secondary btn-lg" disabled 
              data-bs-toggle="tooltip" 
              data-bs-placement="bottom" 
              title="<%= !layout_configured ? '비표준 레이아웃의 경로 설정이 필요합니다' : '모든 설정을 완료한 후 마이그레이션을 시작할 수 있습니다' %>">
        <i class="bi bi-rocket me-2"></i>마이그레이션 시작
      </button>
    <% end %>
  </div>
</div>

<%= render @repository %>

<div class="mt-5">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h3 class="mb-0">
      <i class="bi bi-clock-history me-2"></i>Job History
    </h3>
    <% if @repository.jobs.any? %>
      <%= link_to jobs_path(repository_id: @repository.id), class: "btn btn-sm btn-outline-primary" do %>
        <i class="bi bi-list"></i> View All Jobs
      <% end %>
    <% end %>
  </div>
  <% if @repository.jobs.any? %>
    <div class="table-responsive">
      <table class="table table-hover">
      <thead>
        <tr>
          <th>Type</th>
          <th>Status</th>
          <th>Started</th>
          <th>Duration</th>
          <th>Progress</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <% @repository.jobs.recent.limit(10).each do |job| %>
          <tr>
            <td><%= job.job_type.humanize %></td>
            <td>
              <% status_icon = case job.status
                 when 'completed' then 'bi-check-circle-fill'
                 when 'failed' then 'bi-x-circle-fill'
                 when 'running' then 'bi-arrow-repeat'
                 when 'cancelled' then 'bi-dash-circle-fill'
                 else 'bi-hourglass-split'
                 end %>
              <span class="status-badge status-<%= job.status %>">
                <i class="bi <%= status_icon %>"></i>
                <%= job.status.capitalize %>
              </span>
            </td>
            <td><%= job.started_at&.strftime('%Y-%m-%d %H:%M') || '-' %></td>
            <td><%= job.formatted_duration %></td>
            <td>
              <% if job.active? %>
                <div class="d-flex align-items-center">
                  <div class="progress" style="width: 100px; height: 20px;">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" 
                         role="progressbar"
                         style="width: <%= job.progress_percentage %>%"
                         aria-valuenow="<%= job.progress_percentage %>"
                         aria-valuemin="0"
                         aria-valuemax="100">
                      <%= job.progress_percentage %>%
                    </div>
                  </div>
                  <% if job.current_revision && job.total_revisions && job.total_revisions > 0 %>
                    <small class="text-muted ms-2">
                      r<%= job.current_revision %> / <%= job.total_revisions %>
                    </small>
                  <% end %>
                </div>
              <% else %>
                <div class="d-flex align-items-center">
                  <div class="progress" style="width: 100px; height: 20px;">
                    <div class="progress-bar <%= job.completed? ? 'bg-success' : 'bg-danger' %>" 
                         role="progressbar"
                         style="width: <%= job.progress_percentage %>%"
                         aria-valuenow="<%= job.progress_percentage %>"
                         aria-valuemin="0"
                         aria-valuemax="100">
                      <small><%= job.progress_percentage %>%</small>
                    </div>
                  </div>
                </div>
              <% end %>
            </td>
            <td>
              <%= link_to job_path(job), class: "btn btn-sm btn-outline-primary" do %>
                <i class="bi bi-eye"></i> View
              <% end %>
            </td>
          </tr>
        <% end %>
      </tbody>
      </table>
    </div>
    
    <% if @repository.jobs.count > 10 %>
      <p><%= link_to "View all #{@repository.jobs.count} jobs", jobs_path(repository_id: @repository.id) %></p>
    <% end %>
  <% else %>
    <div class="empty-state">
      <i class="bi bi-inbox"></i>
      <p>No jobs have been run for this repository yet.</p>
    </div>
  <% end %>
</div>

<div class="mt-5 pt-4 border-top">
  <div class="action-buttons">
    <%= link_to edit_repository_path(@repository), class: "btn-secondary-action" do %>
      <i class="bi bi-pencil"></i> Edit Repository
    <% end %>
    <%= link_to repositories_path, class: "btn btn-outline-secondary" do %>
      <i class="bi bi-arrow-left"></i> Back to Repositories
    <% end %>
    <div class="ms-auto">
      <%= button_to @repository, method: :delete, 
                    data: { confirm: "Are you sure you want to delete this repository? This action cannot be undone." }, 
                    class: "btn-danger-action" do %>
        <i class="bi bi-trash"></i> Delete Repository
      <% end %>
    </div>
  </div>
</div>
